import{aK as ae,a as se,r as o,u as oe,K as y,f as ne,o as ce,M as d,j as e,H as re,q as ie,S as E,B as m,E as T,cI as L,cJ as M,cK as le,cf as I,v as de,T as g,cL as pe,D as me,C as he,n as ue,cM as xe,cN as ge,d as fe,e as ye,cO as j,cP as je,p as be}from"./index-fhA8hu8c.js";const _e=fe().shape({doc_type:ye().required("Document type is required")});function Pe(){var U;const R=ae(),v=se(),[b,W]=o.useState(""),{vendor:s}=oe(),[i,_]=o.useState([]),[r,D]=o.useState([]),[$,S]=o.useState(!1),[B,O]=o.useState([]),[C,w]=o.useState([]),[De,z]=o.useState([]),[H,V]=o.useState([]),[f,q]=o.useState([]),A=o.useMemo(()=>({doc_type:"",csp_code:""}),[]);o.useEffect(()=>{s&&y.get(`http://ec2-54-173-125-80.compute-1.amazonaws.com:8080//nccf/branch/${s==null?void 0:s.branch}/csp/list`).then(t=>{var a;return V((a=t==null?void 0:t.data)==null?void 0:a.data)}).catch(t=>console.log(t)),F()},[s==null?void 0:s.csp_code]),o.useEffect(()=>{F(),q([...B,...r])},[r]);function F(){s!=null&&s.csp_code&&y.get(`http://ec2-54-173-125-80.compute-1.amazonaws.com:8080/nccf/csp/${s==null?void 0:s.csp_code}/documents`).then(t=>{var a;return O((a=t==null?void 0:t.data)==null?void 0:a.data)}).catch(t=>console.error(t))}const P=ne({defaultValues:A,resolver:ce(_e)}),{handleSubmit:K,control:G,setValue:Se,watch:J}=P,N=J("doc_type"),k=K(async t=>{var h;if(!((h=i[0])!=null&&h.preview))return d("Please Select Image",{variant:"error"}),!1;const a={type:t.doc_type,image:i[0],id:Date.now()};D(l=>[...l,a]),_([]);const n=new FormData;n.append("doc_type",t.doc_type),n.append("csp_code",s);for(let l of i)try{n.append("file",l)}catch(u){console.error("Error compressing file:",u),n.append("file",l)}}),Y=[{label:"Milling Unit Photo",key:"milling_unit_photo"},{label:"Milling Unit Video",key:"milling_unit_video"}];o.useEffect(()=>{var t;(t=i[0])!=null&&t.preview&&k()},[i]);const Q=o.useCallback(t=>{_([...i,...t.map(a=>Object.assign(a,{preview:URL.createObjectURL(a)}))])},[i]),X=async t=>{var h,l,u;const a=f==null?void 0:f.filter(p=>p.doc_type===b||p.type===b);if(a.length>=5){d(e.jsxs(m,{sx:{p:"5px"},children:[e.jsx(g,{variant:"subtitle1",style:{fontWeight:"bold"},children:` ${j((h=a[0])==null?void 0:h.doc_type)} upload limit exceed`}),e.jsx(g,{variant:"body2",children:`If you want to upload more document of ${j((l=a[0])==null?void 0:l.doc_type)}, then remove existing ${j((u=a[0])==null?void 0:u.doc_type)} document.`})]}),{variant:"error",autoHideDuration:3e3});return}S(!0);const n={maxSizeMB:.5,maxWidthOrHeight:1200,useWebWorker:!0};try{const p=await Promise.all(t.map(async c=>{const x=new FormData,we=await je(c==null?void 0:c.image,n);return x.append("file",c==null?void 0:c.image),x.append("doc_type",c==null?void 0:c.type),x.append("csp_code",s==null?void 0:s.csp_code),x}));await Promise.all(p.map(c=>y.post("http://ec2-54-173-125-80.compute-1.amazonaws.com:8080/nccf/csp/upload_document",c,{headers:{"Content-Type":"multipart/form-data"}})))?(d("Your Document Uploaded"),v.push(be.dashboard.document.document_list),w([])):d("Failed to Upload",{variant:"error"})}catch(p){console.error("Error submitting form:",p),d("Failed to Upload",{variant:"error"})}finally{S(!1)}},Z=o.useCallback(t=>{const a=r.filter(n=>n.id!==t);d("Delete success!"),D(a)},[d,r]);o.useRef(null);const ee=o.useCallback(t=>{z(t.target.value),w(t.target.value)},[C]),te=e.jsxs(e.Fragment,{children:[e.jsx(re,{children:e.jsx("title",{children:"Dashboard | Upload Evidence"})}),e.jsx(ie,{children:e.jsx(E,{spacing:3,sx:{p:3},children:e.jsxs(E,{children:[e.jsxs(m,{rowGap:3,columnGap:2,display:"grid",gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)",md:"repeat(2, 1fr)"},children:[(s==null?void 0:s.category)==="branch"&&e.jsxs(T,{sx:{flexShrink:0},children:[e.jsx(L,{children:"CSP"}),e.jsx(M,{value:C,onChange:ee,input:e.jsx(le,{label:"Type"}),MenuProps:{PaperProps:{sx:{maxHeight:240}}},children:H.map(t=>e.jsx(I,{value:t.csp_code,children:t.name},t.csp_code))})]}),e.jsx(de,{name:"doc_type",control:G,render:({field:t,fieldState:a})=>e.jsxs(T,{fullWidth:!0,error:!!a.error,children:[e.jsx(L,{children:"Document Type"}),e.jsx(M,{...t,label:"Document Type",disabled:r.length>=5,onChange:n=>{t.onChange(n),W(n.target.value)},children:Y.map(n=>e.jsx(I,{value:n.key,children:n.label},n.key))}),a.error&&e.jsx(g,{variant:"caption",color:"error",children:a.error.message})]})})]}),e.jsxs(m,{sx:{position:"relative"},children:[e.jsx(pe,{sx:{height:"100px",width:"100px",position:"absolute",right:"0%",zIndex:"200",opacity:"0"},accept:N==="milling_unit_photo"?{"image/jpeg":[],"image/jpg":[],"image/png":[]}:{"video/mp4":[],"video/avi":[],"video/mkv":[],"video/mov":[]},disabled:r.length>=5,multiple:!0,onDrop:Q}),e.jsx(m,{sx:{display:"flex",justifyContent:"flex-end",mt:"20px"},children:e.jsx(me,{style:{cursor:"pointer",maxWidth:"200px"},variant:"contained",children:"Choose File"})})]})]})})})]});return e.jsx(e.Fragment,{children:e.jsx(he,{maxWidth:R.themeStretch?!1:"xl",children:$?e.jsx(m,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"80vh"},children:e.jsx(ue,{sx:{margin:"auto"}})}):e.jsxs(e.Fragment,{children:[e.jsx(g,{variant:"h4",children:"Upload Evidence"}),e.jsxs(m,{sx:{mt:5,width:1,height:320,borderRadius:2},children:[e.jsx(xe,{methods:P,onSubmit:k,children:te}),((U=r[0])==null?void 0:U.type)&&e.jsx(ge,{data:r,handleDeleteRow:Z,handleAllSubmit:X})]})]})})})}export{Pe as default};
